# 命令行通信软件

基于c++实现的通信软件，仿照linux内核让用户在Windows的command line界面上通过设计好的命令来进行交互。

# 环境

* 服务端：一台公网服务器，系统Ubuntu20.04 LTS。
* 客户端：在Windows10上开发，使用VS2022编译运行。
* C++14
* Mysql

# 技术特点

## 服务端

- 利用**IO复用**技术**Epoll**与**线程池**实现了多线程的**同步非阻塞Reactor**高并发模型；
- 利用**RAII**机制与**mysql句柄**操作实现了数据库连接池，减少数据库连接建立与关闭的开销，实现了用户注册登录功能；
- 利用单例模式与阻塞队列实现了**同步/异步日志系统**，记录服务器运行状态。

## 客户端

- 自主设计了**命令系统**，并仿照linux中的shell设计了简单的**命令输入与解析**；
- 实现了不同内网环境下的**P2P文件传输**：利用UDP打洞技术实现了**内网穿透**，并参考**Quic协议**自主设计并实现了基于UDP的**可靠文件传输**；
- 利用枚举类**enum class**设计**状态机**解决了**多线程交互**（输入与输出）冲突的问题，冲突是由于只有一个命令行界面进行显示与输入。

# 功能

* 主要有三种功能
  * 命令：客户端**向服务器发送命令进行交互**，命令行状态下直接输入，在其他状态下使用@字符：@cmd
  * 聊天：客户之间能进行文字聊天通信，数据通信路径为**客户->服务器->客户**，这样服务器可以记录聊天数据
    * 需要**注册登录**，有一个唯一的登录id，链接到数据库；
    * 登录后可以设置**标识字符串sid(search id)**，以及标识用户名sname。sid用于其他客户寻找本用户，即建立一个临时的会话（好玩的地方），sid在同一时间不能相同；标识用户名可任意，通信时显示。
  * 文件传输：进行p2p的文件传输
    * 用户A可以通过命令获取用户B的文件资源表（resource文件夹下放置可传输的文件），经用户B同意后可以传输
    * 用户A也可以主动发送文件给用户B，用户B同意后可接收
* 调用主要以命令为主，本质是一台状态机，难点在于用户只有单个输入输出界面，状态不能交叉影响

# 框架结构图

* 服务端使用Reactor模型，acceptor在主线程执行，业务处理交付给线程池。
* 客户端通过TCP套接字与服务器端连接，进行命令交互与消息转发。
* 如果进行P2P文件传输，服务端要充当UDP打洞技术中的公网服务器，两个对等方在进行内网穿透后基于UDP进行可靠文件传输。

![orange架构](https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/orange%E6%9E%B6%E6%9E%84.png)

# 命令系统

用户在普通情况下是一个命令行输入，即`cmd> `，这里为了清楚标识，命令关键字以**@**标识。

|                      命令                      |                             作用                             |
| :--------------------------------------------: | :----------------------------------------------------------: |
| @register [userID] [password] [password again] |      注册一个账号，用户名和密码不能含空格，用户名不能重      |
|           @login [userID] [password]           |                           登录账号                           |
|                 @search [sid]                  | 搜索某个sid，若存在则返回对方sname和是否在chat的信息；对方不会知道有用户搜索ta |
|                  @chat [sid]                   |              准备进入chat状态，描述较长见表格后              |
|                 @accept [sid]                  | 接受某个sid，收到chat请求后会维护更新本地客户端的一个请求表，需要存在该sid |
|                 @reject [sid]                  | 拒绝某个sid，收到chat请求后会维护更新本地客户端的一个请求表，需要存在该sid |
|                     @break                     |          退出状态，进入命令行状态，描述较长见表格后          |
|               @send [sid] [msg]                |  直接向某个sid（若存在）发送一条信息，对方会得知sid和sname   |
|             @sendfile [sid] [path]             | 直接向某个sid（若存在）发送一条文件发送信息，对方会得知sid和sname和文件名，进入等待 |
|               @acceptfile [sid]                |              接收某sid发送的文件，返回接收信息               |
|               @rejectfile [sid]                |              拒绝某sid发送的文件，返回拒绝信息               |
|                 @getfile [sid]                 |   请求获取对方的文件资源表，对方会得知sid和sname，进入等待   |
|                @acceptget [sid]                |       同意对方获取资源，返回接受信息，等待对方选择文件       |
|                @rejectget [sid]                |                拒绝对方获取资源，返回拒绝信息                |
|                @setsid [newsid]                |              设置sid，不设置默认用登录的userID               |
|              @setsname [newsname]              |             设置sname，不设置默认用登录的userID              |
|                      @re                       |                        重复上一条命令                        |
|                     @exit                      |                             退出                             |
|                  @hisir [msg]                  |          向服务器说点事情，会得到服务器返回的一句话          |
|                  @myresource                   |                      打印自己的资源列表                      |
|                    @oyasumi                    |                     退出，向服务器说晚安                     |

* @chat：直接与某个sid用户通信，如果没有该sid会返回错误信息1；否则对方会接收到请求，获得你的sid和sname，并选择是否接受。若拒绝则返回拒绝信息；若接受则进入chat状态。用户在调用chat命令后，会进入等待状态（等待对方接受）
* @break：
  * 退出等待状态，这会告知对方已经不请求chat了，同时删除对方的请求表中的sid，返回命令行状态
  * 退出chat状态，这会告知对方已经断开chat了，返回命令行状态
  * 退出发送文件等待状态，和chat一样
  * 退出获取文件资源表的等待状态
* @sendfile：调用break可以退出等待；若对方接收，会开辟一个发送文件线程；若对方拒绝，直接退出等待
* @getfile：若对方同意，则可以开始选择文件

# 示例

![image-20221218204026653](https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/orange%E7%A4%BA%E4%BE%8B1.png)

![image-20221218204723950](https://fastly.jsdelivr.net/gh/Chen-Jin-yuan/blogSources@master/orange%E7%A4%BA%E4%BE%8B2.png)